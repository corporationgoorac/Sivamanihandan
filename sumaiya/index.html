<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Special Day</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,400&family=Montserrat:wght@300;400;600&family=Playfair+Display:ital,wght@0,600;1,400&display=swap" rel="stylesheet">

    <style>
        /* --- 1. LUXURY THEME --- */
        :root {
            --bg: #080808;
            --surface: #121212;
            --text-main: #e0e0e0;
            --gold: #d4af37;
            --gold-dim: #8a7030;
            --accent: #ff4081;
            --ease: cubic-bezier(0.25, 1, 0.5, 1);
            --slow-ease: cubic-bezier(0.19, 1, 0.22, 1); /* New Premium Ease */
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0;
            background-color: var(--bg);
            color: var(--text-main);
            font-family: 'Montserrat', sans-serif;
            height: 100dvh;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #app {
            width: 100%; height: 100%;
            max-width: 480px;
            background: radial-gradient(circle at top, #1a1a1a 0%, #000 70%);
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 0 40px rgba(0,0,0,0.8);
        }

        /* --- 2. TRANSITIONS --- */
        .view {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.8s var(--ease), transform 0.8s var(--ease);
            transform: scale(0.95);
            padding: 20px;
            z-index: 1;
        }

        .view.active {
            opacity: 1;
            pointer-events: all;
            transform: scale(1);
            z-index: 10;
        }

        /* --- 3. GIFT BOX --- */
        .gift-wrapper { cursor: pointer; text-align: center; }
        .gift-icon { font-size: 5rem; filter: drop-shadow(0 0 20px rgba(212, 175, 55, 0.3)); animation: float 3s ease-in-out infinite; }
        .tap-hint { margin-top: 25px; font-size: 0.8rem; letter-spacing: 3px; text-transform: uppercase; color: var(--gold); opacity: 0.8; animation: pulse 2s infinite; }

        /* --- 4. COUNTER --- */
        .counter-wrapper { text-align: center; }
        .counter-label { font-size: 0.9rem; letter-spacing: 2px; text-transform: uppercase; color: #666; margin-bottom: 20px; }
        .big-number { font-family: 'Playfair Display', serif; font-size: 6rem; line-height: 1; font-weight: 600; color: var(--gold); font-variant-numeric: tabular-nums; text-shadow: 0 0 30px rgba(212, 175, 55, 0.2); }
        .counter-detail { margin-top: 15px; font-size: 1.2rem; color: #fff; min-height: 1.5em; }

        /* --- 5. CONTENT PAGES --- */
        .text-panel { text-align: center; margin-bottom: 20px; min-height: 60px; display: flex; align-items: center; justify-content: center; z-index: 20; }
        .poetic-text { font-family: 'Playfair Display', serif; font-style: italic; font-size: 1.1rem; line-height: 1.6; color: #ddd; animation: fadeIn 1.5s ease forwards; }

        /* Video Frame */
        .video-box { width: 100%; flex: 1; background: #000; border: 1px solid #222; border-radius: 8px; overflow: hidden; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        video { width: 100%; height: 100%; object-fit: contain; }

        /* Navigation */
        .nav-area { width: 100%; padding-top: 20px; display: flex; justify-content: center; gap: 20px; position: relative; z-index: 50; }
        button { background: transparent; border: 1px solid rgba(255,255,255,0.2); color: #fff; padding: 12px 24px; font-family: 'Montserrat', sans-serif; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; border-radius: 4px; cursor: pointer; transition: all 0.3s; }
        button.primary { background: var(--gold); color: #000; border-color: var(--gold); font-weight: 600; box-shadow: 0 5px 15px rgba(212, 175, 55, 0.3); }
        button:active { transform: scale(0.96); }

        /* Titles */
        h2 { font-family: 'Playfair Display', serif; font-size: 2rem; margin: 0; color: var(--gold); }
        h3 { font-weight: 300; font-size: 1rem; letter-spacing: 2px; margin: 5px 0 0 0; text-transform: uppercase; color: #aaa; }

        /* --- 6. PERSONALITY STYLES --- */
        .profile-container { display: flex; flex-direction: column; align-items: center; width: 100%; height: 100%; }
        .profile-img-box { position: relative; margin-bottom: 20px; }
        .profile-img { width: 120px; height: 120px; border-radius: 50%; border: 2px solid var(--gold); object-fit: cover; box-shadow: 0 0 25px rgba(212, 175, 55, 0.4); animation: pulse-border 3s infinite; }
        .header-title { color: var(--gold); font-family: 'Playfair Display', serif; font-size: 1.5rem; margin-bottom: 5px; }
        .header-sub { color: #666; font-size: 0.7rem; letter-spacing: 3px; text-transform: uppercase; margin-bottom: 20px; }
        .scrolling-content { flex: 1; width: 100%; background: rgba(255, 255, 255, 0.03); border-left: 2px solid var(--gold-dim); padding: 15px; overflow-y: auto; text-align: left; font-family: 'Montserrat', sans-serif; font-size: 0.95rem; line-height: 1.8; color: #ddd; scrollbar-width: thin; scrollbar-color: var(--gold-dim) #111; }
        .word-span { opacity: 0; display: inline-block; margin-right: 5px; animation: fadeWord 0.5s ease forwards; }

        /* --- 7. BLESSINGS/DUA --- */
        .blessing-container { flex: 1; width: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .moon-icon { font-size: 3rem; margin-bottom: 10px; color: var(--gold); text-shadow: 0 0 15px rgba(212, 175, 55, 0.5); animation: float 4s ease-in-out infinite; }
        .dua-display { width: 100%; flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(255,255,255,0.03); border: 1px solid rgba(212, 175, 55, 0.2); border-radius: 12px; padding: 30px 20px; margin: 20px 0; position: relative; transition: transform 0.3s; }
        .dua-arabic { font-family: 'Amiri', serif; font-size: 2rem; color: var(--gold); line-height: 1.8; margin-bottom: 20px; text-align: center; direction: rtl; }
        .dua-english { font-family: 'Playfair Display', serif; font-style: italic; font-size: 1rem; color: #ddd; line-height: 1.6; text-align: center; }
        .dua-controls { display: flex; justify-content: center; align-items: center; gap: 30px; margin-bottom: 10px; }
        .arrow-btn { background: none; border: 1px solid var(--gold-dim); color: var(--gold); width: 40px; height: 40px; border-radius: 50%; font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.3s; }
        .arrow-btn:hover { background: var(--gold); color: #000; }
        .dua-counter { color: #666; font-size: 0.8rem; letter-spacing: 2px; }

        /* --- 8. LANTERNS --- */
        .lantern-scene { position: relative; width: 100%; flex: 1; overflow: hidden; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; padding-bottom: 60px; background: linear-gradient(to top, #000510 0%, #000 80%); }
        .lantern-text { position: absolute; top: 20%; width: 100%; text-align: center; font-family: 'Playfair Display', serif; font-size: 1.4rem; color: var(--gold); text-shadow: 0 0 10px rgba(212, 175, 55, 0.5); opacity: 0; transition: opacity 1s ease; z-index: 5; pointer-events: none; }
        .water-reflection { position: absolute; bottom: 0; width: 100%; height: 25%; background: linear-gradient(to top, rgba(0,10,30,0.8), transparent); z-index: 1; pointer-events: none; }
        .lantern { position: absolute; background: rgba(255,255,255,0.1); width: 35px; height: 50px; border-radius: 6px 6px 4px 4px; bottom: 10%; transition: all 0.8s ease; cursor: pointer; border: 1px solid rgba(255,255,255,0.2); }
        .lantern.main-lantern { bottom: 50px; width: 50px; height: 70px; z-index: 10; left: 50%; transform: translateX(-50%); }
        .lantern::after { content:''; position: absolute; bottom:0; left:0; right:0; height: 4px; background: #555; }
        .lantern.lit { background: radial-gradient(circle at center, #fff, #ffcc00, #d4af37); box-shadow: 0 0 30px rgba(255, 200, 0, 0.6), 0 0 60px rgba(255, 100, 0, 0.2); border: none; }
        .lantern.fly { animation: floatUpSky 12s linear forwards; pointer-events: none; }
        .bg-lantern { position: absolute; width: 20px; height: 30px; background: radial-gradient(circle, #fff, #ffcc00); border-radius: 4px; opacity: 0; box-shadow: 0 0 10px #ffcc00; pointer-events: none; z-index: 2; }
        .bg-lantern.rise { animation: riseUp 10s linear forwards; }

        @keyframes floatUpSky { 0% { transform: translateX(-50%) translateY(0) scale(1); opacity: 1; } 100% { transform: translateX(-50%) translateY(-120vh) scale(0.5); opacity: 0; } }
        @keyframes riseUp { 0% { transform: translateY(100vh) scale(0.5); opacity: 0; } 20% { opacity: 0.8; } 100% { transform: translateY(-20vh) scale(0.2); opacity: 0; } }

        /* --- 9. FINAL WISHES STYLES --- */
        .media-box { 
            width: 100%; 
            flex: 1; 
            background: transparent; 
            border: 1px solid transparent; 
            overflow: visible; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            position: relative; 
        }
        .wish-image { 
            max-width: 85%; 
            max-height: 60vh;
            width: auto; 
            height: auto; 
            object-fit: contain; 
            opacity: 0; 
            position: absolute; 
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.2);
            transition: opacity 1s ease;
        }
        .wish-image.active-img { 
            opacity: 1; 
            animation: floatImage 3s ease-in-out infinite alternate;
        }

        /* --- 10. STORY ALBUM STYLES (NEW ANIMATIONS) --- */
        .story-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding-bottom: 20px;
        }
        .story-photo-frame {
            flex: 1;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            perspective: 1200px; /* For 3D Effect */
        }
        
        /* NEW PHOTO ANIMATION: 3D Flip & Blur Entrance */
        .story-img {
            max-width: 90%;
            max-height: 55vh;
            border-radius: 12px;
            border: 1px solid var(--gold-dim);
            box-shadow: 0 10px 40px rgba(0,0,0,0.6);
            
            /* Initial State */
            opacity: 0;
            transform: rotateX(15deg) translateY(40px) scale(0.9);
            filter: blur(10px);
            transition: all 1.2s var(--slow-ease);
        }

        .story-img.visible {
            opacity: 1;
            transform: rotateX(0deg) translateY(0) scale(1);
            filter: blur(0px);
            box-shadow: 0 20px 60px rgba(212, 175, 55, 0.15);
        }

        .story-text-box {
            width: 90%;
            min-height: 110px;
            background: linear-gradient(to right, rgba(255,255,255,0.05), transparent);
            border-left: 3px solid var(--gold);
            padding: 20px;
            margin: 15px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            border-radius: 0 10px 10px 0;
            backdrop-filter: blur(5px);
            
            opacity: 0;
            transform: translateX(-20px);
            transition: all 1s var(--ease);
        }

        .story-text-box.show-text {
            opacity: 1;
            transform: translateX(0);
        }

        .story-caption {
            font-family: 'Playfair Display', serif;
            font-size: 1rem;
            line-height: 1.6;
            color: #eee;
        }

        /* --- 11. GRAND FINALE STYLES --- */
        .grand-title { 
            font-family: 'Playfair Display', serif; 
            font-size: 4rem; 
            color: var(--gold); 
            text-align: center; 
            line-height: 1.2; 
            text-shadow: 0 0 30px rgba(212, 175, 55, 0.5); 
            animation: float 3s ease-in-out infinite; 
        }

        /* --- ANIMATIONS --- */
        @keyframes floatImage { 0% { transform: translateY(0); } 100% { transform: translateY(-10px); } }
        @keyframes float { 0%, 100% {transform:translateY(0);} 50% {transform:translateY(-15px);} }
        @keyframes pulse { 0%, 100% {opacity: 0.5;} 50% {opacity: 1;} }
        @keyframes fadeIn { from {opacity:0; transform:translateY(10px);} to {opacity:1; transform:translateY(0);} }
        @keyframes pulse-border { 0% {box-shadow:0 0 0 0 rgba(212,175,55,0.4);} 70% {box-shadow:0 0 0 10px transparent;} 100% {box-shadow:0 0 0 0 transparent;} }
        @keyframes fadeWord { 0% { opacity: 0; transform: translateY(5px); color: var(--gold); } 100% { opacity: 1; transform: translateY(0); color: #ddd; } }
        .fade-in { animation: fadeInDua 0.5s ease forwards; }
        @keyframes fadeInDua { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

    </style>
</head>
<body>

    <audio id="audio-nasheed" preload="auto" loop><source src="duo.mp3" type="audio/mpeg"></audio>
    <audio id="audio-personality" preload="auto"><source src="neenda_neenda_kalam.mp3" type="audio/mpeg"></audio>
    <audio id="audio-song1" preload="auto" loop><source src="song1.mp3" type="audio/mpeg"></audio>
    <audio id="audio-song2" preload="auto" loop><source src="song2.mp3" type="audio/mpeg"></audio>

    <audio id="story-audio-1" preload="auto" loop><source src="1.mp3" type="audio/mpeg"></audio>
    <audio id="story-audio-2" preload="auto" loop><source src="2.mp3" type="audio/mpeg"></audio>
    <audio id="story-audio-3" preload="auto" loop><source src="3.mp3" type="audio/mpeg"></audio>
    <audio id="story-audio-4" preload="auto" loop><source src="4.mp3" type="audio/mpeg"></audio>

    <div id="app">

        <div id="v-start" class="view active">
            <div class="gift-wrapper" onclick="startJourney()">
                <div class="gift-icon">üéÅ</div>
                <div class="tap-hint">Tap to Open</div>
            </div>
        </div>

        <div id="v-rewind" class="view">
            <div class="counter-wrapper">
                <div class="counter-label">Rewinding Time</div>
                <div id="num-rewind" class="big-number">2026</div>
                <div id="detail-rewind" class="counter-detail"></div>
            </div>
        </div>

        <div id="v-born" class="view">
            <div class="text-panel">
                <div class="poetic-text">
                    "On that day, the sky was dark... Not because it was a new moon, but because the Moon itself had come down to Earth."
                </div>
            </div>
            <div class="video-box">
                <video id="vid-born" playsinline loop src="born.mp4"></video>
            </div>
            <div class="nav-area">
                <button class="primary" onclick="startForward()">Start Journey</button>
            </div>
        </div>

        <div id="v-forward" class="view">
            <div class="counter-wrapper">
                <div class="counter-label">Growing Up</div>
                <div id="num-forward" class="big-number">2005</div>
                <div id="detail-forward" class="counter-detail">Age: 0</div>
            </div>
        </div>

        <div id="v-wishes" class="view">
            <div class="text-panel" style="flex-direction: column;">
                <h2>Happy Birthday</h2>
                <h3>Fathima Sumaiya</h3>
            </div>
            <div class="video-box">
                <video id="vid-wishes" playsinline loop src="wishes.mp4"></video>
            </div>
            <div class="nav-area">
                <button onclick="goto('v-born')">Back</button>
                <button class="primary" onclick="goto('v-blessings')">Next</button>
            </div>
        </div>

        <div id="v-blessings" class="view">
            <div class="blessing-container">
                <div class="moon-icon">‚òæ</div>
                <div class="header-title" style="margin-bottom:20px;">The Prayers</div>
                
                <div id="dua-card-box" class="dua-display">
                    <div id="dua-ar" class="dua-arabic">...</div>
                    <div id="dua-en" class="dua-english">...</div>
                </div>

                <div class="dua-controls">
                    <button class="arrow-btn" onclick="prevDua()">&#8592;</button>
                    <span id="dua-counter" class="dua-counter">1 / 5</span>
                    <button class="arrow-btn" onclick="nextDua()">&#8594;</button>
                </div>

                <div class="nav-area" style="margin-top: 10px;">
                    <button onclick="goto('v-wishes')">Back</button>
                    <button class="primary" onclick="goto('v-lanterns')">Next</button>
                </div>
            </div>
        </div>

        <div id="v-lanterns" class="view">
            <div class="lantern-scene" id="lantern-scene">
                <div id="lantern-msg" class="lantern-text">Close your eyes and make a wish...</div>
                <div id="sky-container"></div> 
                <div class="water-reflection"></div>
                <div id="main-lantern" class="lantern main-lantern" onclick="releaseLantern()"></div>
            </div>
            <div id="lantern-nav" class="nav-area">
                <button onclick="goto('v-blessings')">Back</button>
                <button class="primary" onclick="goto('v-aafika')">Next</button>
            </div>
        </div>

        <div id="v-aafika" class="view">
            <div class="text-panel" style="flex-direction: column;">
                <h2>Little Aafika</h2>
                <h3>Sending Love</h3>
            </div>
            <div class="video-box">
                <video id="vid-aafika" playsinline loop src="aafika.mp4"></video>
            </div>
            <div class="nav-area">
                <button onclick="goto('v-lanterns')">Back</button>
                <button class="primary" onclick="startPersonality()">Next</button>
            </div>
        </div>

        <div id="v-personality" class="view">
            <div class="profile-container">
                <div class="profile-img-box">
                    <img src="face.png" alt="Her Photo" class="profile-img">
                </div>
                <div class="header-title">The Perception</div>
                <div class="header-sub">HOW I SEE YOU</div>
                
                <div id="personality-stream" class="scrolling-content"></div>

                <div class="nav-area">
                    <button onclick="goto('v-aafika')">Back</button>
                    <button class="primary" onclick="goto('v-final-wishes')">Next</button>
                </div>
            </div>
        </div>

        <div id="v-final-wishes" class="view">
            <div class="text-panel" style="min-height: 120px; display:flex; align-items:center; justify-content:center;">
                <div id="final-caption" class="poetic-text" style="color: var(--gold); text-align: center; font-size: 1.1rem; line-height: 1.8;">
                    ...
                </div>
            </div>
            
            <div class="media-box">
                <img id="img-wish-1" src="pic1.jpg" class="wish-image" alt="School Steps">
                <img id="img-wish-2" src="pic2.jpg" class="wish-image" alt="Reading">
                <img id="img-wish-3" src="pic3.jpg" class="wish-image" alt="Hope">
                <img id="img-wish-4" src="pic4.jpg" class="wish-image" alt="Window">
            </div>

            <div class="nav-area">
                <button onclick="goto('v-personality')">Back</button>
                <button id="btn-next-wish" class="primary" onclick="nextWishSlide()">Next Wish</button>
            </div>
        </div>

        <div id="v-story-album" class="view">
            <div class="story-container">
                <div class="story-photo-frame">
                    <img id="story-main-img" src="" alt="Memory" class="story-img">
                </div>
                
                <div id="story-text-container" class="story-text-box">
                    <div id="story-text-content" class="story-caption">
                        Loading...
                    </div>
                </div>

                <div class="nav-area">
                    <button id="btn-story-next" class="primary" onclick="nextStorySlide()">Next</button>
                </div>
            </div>
        </div>

        <div id="v-grand-finale" class="view">
            <h1 class="grand-title">Happy Birthday<br>21</h1>
        </div>

    </div>

    <script src="data1.js"></script>

    <script>
        /* =========================================
           DATA CONFIGURATION
           ========================================= */
        const DUAS = [
            { ar: "ÿ®Ÿéÿßÿ±ŸéŸÉŸé ÿßŸÑŸÑŸéŸëŸáŸè ŸÅŸêŸä ÿπŸèŸÖŸíÿ±ŸêŸÉŸê", en: "May Allah bless your life with barakah, light, and endless happiness." },
            { ar: "ÿßŸÑŸÑŸéŸëŸáŸèŸÖŸéŸë ÿßÿ≠ŸíŸÅŸéÿ∏ŸíŸáŸéÿß ÿ®ŸêÿπŸéŸäŸíŸÜŸêŸÉŸé ÿßŸÑŸéŸëÿ™ŸêŸä ŸÑŸéÿß ÿ™ŸéŸÜŸéÿßŸÖŸè", en: "Oh Allah, protect her with Your eyes that never sleep, and keep her heart safe from all sadness." },
            { ar: "ÿ±Ÿéÿ®ŸêŸë ÿ≤ŸêÿØŸíŸÜŸêŸä ÿπŸêŸÑŸíŸÖŸãÿß ŸàŸéÿßÿ±Ÿíÿ≤ŸèŸÇŸíŸÜŸêŸä ŸÅŸéŸáŸíŸÖŸãÿß", en: "Oh Lord, increase her in knowledge and grant her deep understanding and wisdom in all her choices." },
            { ar: "ÿ±Ÿéÿ®ŸéŸëŸÜŸéÿß ÿ¢ÿ™ŸêŸÜŸéÿß ŸÅŸêŸä ÿßŸÑÿØŸèŸëŸÜŸíŸäŸéÿß ÿ≠Ÿéÿ≥ŸéŸÜŸéÿ©Ÿã ŸàŸéŸÅŸêŸä ÿßŸÑÿ¢ÿÆŸêÿ±Ÿéÿ©Ÿê ÿ≠Ÿéÿ≥ŸéŸÜŸéÿ©Ÿã", en: "Our Lord, grant her goodness in this world and goodness in the Hereafter." },
            { ar: "ŸäŸéÿß ŸÖŸèŸÇŸéŸÑŸêŸëÿ®Ÿé ÿßŸÑŸíŸÇŸèŸÑŸèŸàÿ®Ÿê ÿ´Ÿéÿ®ŸêŸëÿ™Ÿí ŸÇŸéŸÑŸíÿ®ŸêŸä ÿπŸéŸÑŸéŸâ ÿØŸêŸäŸÜŸêŸÉŸé", en: "Oh Turner of hearts, keep her heart steadfast on Your faith and filled with peace." }
        ];

        /* CAPTIONS MAPPED TO PHOTO CONTENT */
        const WISHES = [
            { text: "Looking back at where it all started... May the discipline and dreams of your school days continue to guide you to greatness in your college life and beyond." }, 
            { text: "Always lost in books, even back then. As you pursue higher education now, may your thirst for knowledge write a beautiful success story for your future." }, 
            { text: "You have grown so much since this photo was taken. Like the nature around you, may your life always bloom with hope, resilience, and endless possibilities." }, 
            { text: "From those school bus rides to the journey you are on now... May Allah protect you, guide your steps, and lead you to the most beautiful destinations." } 
        ];

        const PERSONALITY_TEXT = "You are kind, smart, and wonderful. Happy Birthday!";

        let currentDuaIndex = 0;
        let lanternReleased = false;
        let currentWishIndex = 0;
        let typingInterval = null; 
        
        // NEW STATE FOR STORIES
        let currentStoryIndex = 0;

        /* =========================================
           AUDIO ENGINE (UI Sounds)
           ========================================= */
        const AudioSys = {
            ctx: null,
            init() {
                try {
                    if (!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                    if (this.ctx.state === 'suspended') this.ctx.resume();
                } catch (e) { console.log("Audio Init Error", e); }
            },
            playTone(freq, type, dur, vol=0.1) {
                if(!this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                gain.gain.setValueAtTime(vol, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + dur);
                osc.connect(gain); gain.connect(this.ctx.destination);
                osc.start(); osc.stop(this.ctx.currentTime + dur);
            },
            tick() { this.playTone(600, 'sine', 0.05, 0.05); },
            click() { this.playTone(800, 'triangle', 0.1, 0.05); },
            data() { this.playTone(1000, 'square', 0.03, 0.02); }, 
            chime() { 
                setTimeout(()=>this.playTone(523.25, 'sine', 1.5, 0.1), 0);
                setTimeout(()=>this.playTone(659.25, 'sine', 1.5, 0.1), 100);
                setTimeout(()=>this.playTone(783.99, 'sine', 1.5, 0.1), 200);
                setTimeout(()=>this.playTone(1046.5, 'sine', 2.0, 0.05), 300);
            }
        };

        /* =========================================
           VIEW MANAGER
           ========================================= */
        function goto(id) {
            AudioSys.click();
            
            // 1. Reset Videos & Views
            document.querySelectorAll('video').forEach(v => v.pause());
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            
            // 2. Audio Control
            const nasheed = document.getElementById('audio-nasheed');
            const personality = document.getElementById('audio-personality');
            const song1 = document.getElementById('audio-song1');
            const song2 = document.getElementById('audio-song2');
            
            // Helper to stop everything including story songs
            const stopAllMain = (exception) => {
                if(exception !== nasheed) { nasheed.pause(); nasheed.currentTime = 0; }
                if(exception !== personality) { personality.pause(); personality.currentTime = 0; }
                if(exception !== song1) { song1.pause(); song1.currentTime = 0; }
                if(exception !== song2) { song2.pause(); song2.currentTime = 0; }
            };

            // 3. Logic per View
            if (id === 'v-blessings') {
                stopAllMain(nasheed);
                stopStoryAudio(); // Ensure story audio is off
                if(nasheed.paused) { nasheed.volume = 0.5; nasheed.play().catch(e=>{}); }
                renderDua(0);
            } 
            else if (id === 'v-personality') {
                stopAllMain(personality);
                if(personality.paused) { personality.currentTime = 3; personality.volume = 0.8; personality.play().catch(e=>{}); }
            } 
            else if (id === 'v-final-wishes') {
                stopAllMain(null); 
                stopStoryAudio();
                currentWishIndex = 0;
                renderFinalWishes();
            }
            else if (id === 'v-story-album') {
                // Stop previous background music
                stopAllMain(null);
                // Start Story Logic
                currentStoryIndex = 0;
                renderStorySlide();
            }
            else if (id === 'v-grand-finale') {
                // Stop everything except the last song playing from story (optional, but clean is better)
                // If you want last song to continue, comment out stopStoryAudio()
                // stopStoryAudio(); 
                stopAllMain(null);
            }
            else {
                // Default clean slate
                stopAllMain(null);
                stopStoryAudio();
            }

            // 4. Page Specific Inits
            if(id === 'v-lanterns') initLanternPage();

            // 5. Show View
            const target = document.getElementById(id);
            target.classList.add('active');

            // 6. Play Video if present
            const vid = target.querySelector('video');
            if(vid) { vid.currentTime = 0; vid.play().catch(e => {}); }
        }

        /* =========================================
           LOGIC: DUAS, LANTERNS
           ========================================= */
        function renderDua(index) {
            const card = document.getElementById('dua-card-box');
            card.classList.remove('fade-in'); void card.offsetWidth; 
            document.getElementById('dua-ar').innerText = DUAS[index].ar;
            document.getElementById('dua-en').innerText = DUAS[index].en;
            document.getElementById('dua-counter').innerText = `${index + 1} / ${DUAS.length}`;
            card.classList.add('fade-in');
        }
        function nextDua() { AudioSys.click(); currentDuaIndex = (currentDuaIndex < DUAS.length - 1) ? currentDuaIndex + 1 : 0; renderDua(currentDuaIndex); }
        function prevDua() { AudioSys.click(); currentDuaIndex = (currentDuaIndex > 0) ? currentDuaIndex - 1 : 0; renderDua(currentDuaIndex); }

        function initLanternPage() {
            lanternReleased = false;
            const lantern = document.getElementById('main-lantern');
            const msg = document.getElementById('lantern-msg');
            const sky = document.getElementById('sky-container');
            lantern.className = 'lantern main-lantern'; lantern.style.pointerEvents = 'none'; sky.innerHTML = '';
            msg.style.opacity = '0'; msg.innerText = "Close your eyes and make a wish...";
            setTimeout(() => { msg.style.opacity = '1'; }, 500);
            setTimeout(() => {
                msg.style.opacity = '0';
                setTimeout(() => { msg.innerText = "Tap the lantern"; msg.style.opacity = '1'; lantern.style.pointerEvents = 'all'; }, 1000);
            }, 4500);
        }

        function releaseLantern() {
            if(lanternReleased) return; lanternReleased = true; AudioSys.chime();
            const lantern = document.getElementById('main-lantern');
            const msg = document.getElementById('lantern-msg');
            lantern.classList.add('lit');
            setTimeout(() => {
                lantern.classList.add('fly'); spawnSkyLanterns();
                msg.style.opacity = '0';
                setTimeout(() => { msg.innerText = "Your wish has reached the heavens"; msg.style.opacity = '1'; }, 2000);
            }, 500);
        }

        function spawnSkyLanterns() {
            const sky = document.getElementById('sky-container');
            for(let i=0; i<30; i++) {
                const l = document.createElement('div'); l.className = 'bg-lantern';
                l.style.left = (Math.random() * 90 + 5) + '%';
                l.style.animationDelay = (Math.random() * 3) + 's';
                l.style.animationDuration = (8 + Math.random() * 5) + 's';
                l.style.transform = `scale(${0.5 + Math.random() * 0.5})`;
                l.classList.add('rise'); sky.appendChild(l);
            }
        }

        /* =========================================
           PAGE: FINAL WISHES (Before Story)
           ========================================= */
        function renderFinalWishes() {
            for(let i=1; i<=4; i++) { document.getElementById(`img-wish-${i}`).classList.remove('active-img'); }
            document.getElementById(`img-wish-${currentWishIndex+1}`).classList.add('active-img');

            const captionBox = document.getElementById('final-caption');
            captionBox.innerHTML = ""; 
            if(typingInterval) clearInterval(typingInterval);

            const words = WISHES[currentWishIndex].text.split(" ");
            let i = 0;
            
            typingInterval = setInterval(() => {
                if(i < words.length) {
                    const span = document.createElement("span");
                    span.innerText = words[i] + " ";
                    span.style.opacity = 0;
                    span.style.animation = "fadeWord 0.8s ease forwards"; 
                    captionBox.appendChild(span);
                    i++;
                } else {
                    clearInterval(typingInterval);
                }
            }, 300); // Slightly faster than before (300ms)

            // Audio for Final Wishes (Song 1 & 2)
            const s1 = document.getElementById('audio-song1');
            const s2 = document.getElementById('audio-song2');

            if(currentWishIndex === 0) {
                s2.pause(); s2.currentTime = 0; 
                if(s1.paused) { s1.currentTime = 0; s1.volume = 0.7; s1.play().catch(e=>{}); }
            } else if (currentWishIndex === 2) {
                s1.pause(); 
                if(s2.paused) { s2.currentTime = 0; s2.volume = 0.7; s2.play().catch(e=>{}); }
            }

            // Update button Text
            const btn = document.getElementById('btn-next-wish');
            btn.style.display = 'inline-block';
            if(currentWishIndex === WISHES.length - 1) {
                btn.innerText = "Continue Journey"; // Indicates moving to next section
            } else {
                btn.innerText = "Next Wish";
            }
        }

        function nextWishSlide() {
            AudioSys.click();
            if(currentWishIndex < WISHES.length - 1) {
                currentWishIndex++;
                renderFinalWishes();
            } else {
                // Move to Story Album
                goto('v-story-album');
            }
        }

        /* =========================================
           PAGE: STORY ALBUM (12 Photos, 4 Songs)
           ========================================= */
        
        function stopStoryAudio() {
            for(let i=1; i<=4; i++) {
                const audio = document.getElementById(`story-audio-${i}`);
                if(audio) { audio.pause(); audio.currentTime = 0; }
            }
        }

        function playStoryAudio(groupIndex) {
            // Group Index: 0 -> Song 1, 1 -> Song 2, 2 -> Song 3, 3 -> Song 4
            // Since we have 12 photos, change song every 3 photos.
            // Safe guard: Max audio is 4. If more photos added (e.g. 13th), keep playing song 4.
            const safeGroupIndex = Math.min(groupIndex, 3); 
            const targetId = `story-audio-${safeGroupIndex + 1}`;
            
            // Pause others
            for(let i=1; i<=4; i++) {
                if(i !== (safeGroupIndex + 1)) {
                    const el = document.getElementById(`story-audio-${i}`);
                    if(!el.paused) { el.pause(); }
                }
            }

            // Play target
            const target = document.getElementById(targetId);
            if(target && target.paused) {
                target.volume = 0.8;
                target.play().catch(e => console.log("Audio Play Error", e));
            }
        }

        function renderStorySlide() {
            // 1. Calculate Song Group (0, 1, 2, 3)
            const group = Math.floor(currentStoryIndex / 3);
            playStoryAudio(group);

            // 2. Update Image with NEW Animation
            const img = document.getElementById('story-main-img');
            img.classList.remove('visible'); // Start exit/reset
            
            setTimeout(() => {
                // Images: 1.png to 12.png (or 13.png if user adds it)
                img.src = `${currentStoryIndex + 1}.png`; 
                img.onload = () => {
                    img.classList.add('visible'); // Trigger Entrance
                };
            }, 500);

            // 3. Update Text with Animation
            const txtBox = document.getElementById('story-text-container');
            const txtContent = document.getElementById('story-text-content');
            
            txtBox.classList.remove('show-text');
            
            setTimeout(() => {
                // FALLBACK IF STORY_DATA IS NOT LOADED
                const caption = (typeof STORY_DATA !== 'undefined' && STORY_DATA[currentStoryIndex]) 
                    ? STORY_DATA[currentStoryIndex] 
                    : "Happy Birthday!";
                    
                txtContent.innerText = caption;
                txtBox.classList.add('show-text');
            }, 600);

            // 4. Update Button Logic - DYNAMIC LAST PHOTO CHECK
            const btn = document.getElementById('btn-story-next');
            
            // Check list length safely
            const totalSlides = (typeof STORY_DATA !== 'undefined') ? STORY_DATA.length : 12;

            if (currentStoryIndex === totalSlides - 1) {
                // LAST SLIDE
                btn.style.display = 'none'; // Hide Button
                
                // Auto-Transition after 6 seconds
                setTimeout(() => {
                    goto('v-grand-finale');
                }, 6000);
            } else {
                btn.style.display = 'inline-block';
                btn.innerText = "Next Memory";
            }
        }

        function nextStorySlide() {
            AudioSys.click();
            const totalSlides = (typeof STORY_DATA !== 'undefined') ? STORY_DATA.length : 12;

            if (currentStoryIndex < totalSlides - 1) {
                currentStoryIndex++;
                renderStorySlide();
            } 
            // Note: Button is hidden on last index, so this won't be clicked
        }


        /* =========================================
           TIMELINE LOGIC
           ========================================= */
        function startJourney() {
            AudioSys.init(); AudioSys.click(); goto('v-rewind');
            const numEl = document.getElementById('num-rewind'); const detailEl = document.getElementById('detail-rewind');
            let year = 2026;
            const timer = setInterval(() => {
                year--; numEl.innerText = year; AudioSys.tick();
                if (year <= 2005) { clearInterval(timer); AudioSys.chime(); detailEl.innerText = "FEB 08"; detailEl.style.color = "var(--gold)"; setTimeout(() => goto('v-born'), 1500); }
            }, 164);
        }

        function startForward() {
            goto('v-forward');
            const vid = document.getElementById('vid-wishes');
            if(vid) vid.load();

            const numEl = document.getElementById('num-forward'); const detailEl = document.getElementById('detail-forward');
            let year = 2005; let age = 0;
            
            const timer = setInterval(() => {
                year++; age++; numEl.innerText = year; detailEl.innerText = "Age: " + age; AudioSys.tick();
                if (age >= 21) { 
                    clearInterval(timer); 
                    AudioSys.chime(); 
                    detailEl.innerText = "TURNING 21"; 
                    detailEl.style.color = "var(--gold)"; 
                    setTimeout(() => goto('v-wishes'), 500); 
                }
            }, 164);
        }

        function startPersonality() {
            goto('v-personality');
            const container = document.getElementById('personality-stream');
            if(container.innerHTML === "") {
                const words = PERSONALITY_TEXT.split(/\s+/); let i = 0;
                const interval = setInterval(() => {
                    if (i < words.length) {
                        const span = document.createElement('span'); span.className = 'word-span'; span.innerText = words[i] + " ";
                        container.appendChild(span); container.scrollTop = container.scrollHeight;
                        if(i % 5 === 0) AudioSys.data(); i++;
                    } else { clearInterval(interval); }
                }, 150);
            }
        }

    </script>
</body>
</html>
